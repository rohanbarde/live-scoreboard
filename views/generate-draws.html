<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Draws | Tournament</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../public/css/player-list.css">
    <link rel="icon" href="../public/assets/JudoIcon.png" type="image/png">

    <style>
        /* Layout */
        .draws-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 20px;
            width: 100%;
        }
        
        .players-column {
            min-width: 0;
        }
        
        .animation-column {
            min-width: 0;
        }
        
        .animation-container {
            background: white;
            border-radius: 12px;
            padding: 16px;
            min-height: 400px;
            max-height: 75vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow);
            overflow-y: auto;
        }
        
        /* Player Cards */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .player-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .player-info {
            flex: 1;
            min-width: 0;
        }
        
        .player-info h4 {
            margin: 0;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-details {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        /* Animation Area */
        #drawsContent {
            position: relative;
            overflow: visible;
        }
        
        .no-players,
        .no-draw {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }
        
        .no-players i,
        .no-draw i {
            font-size: 2rem;
            opacity: 0.5;
            margin-bottom: 10px;
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .draws-layout {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .draws-container {
                padding: 15px;
            }
            
            .draws-content {
                padding: 15px;
            }
        }
        
        .draws-container {
            width: 100%;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .draws-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }
        .draws-content {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-top: 20px;
            width: 100%;
        }
        .draws-section {
            margin-bottom: 30px;
        }
        .draws-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 5px;
        }
        .player-card {
            background: var(--light-gray);
            border-radius: 6px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
            border-left: 4px solid var(--primary-color);
        }
        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }
        .player-info h4 {
            margin: 0;
            font-size: 15px;
            color: var(--text-color);
        }
        .player-details {
            font-size: 13px;
            color: #666;
            margin-top: 3px;
        }
        .no-players {
            text-align: center;
            padding: 30px;
            color: #666;
            font-style: italic;
        }
        @media (max-width: 768px) {
            .filters-container {
                flex-direction: column;
                width: 100%;
            }
            .filter-group {
                width: 100%;
            }
            .filter-select {
                width: 100%;
            }
        }
        .draw-player-card {
            background: white;
            border-radius: 8px;
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            min-width: 0;
            width: 100%;
            max-width: 100%;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }

        .draw-player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .draw-player-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-color);
            margin: 0;
            line-height: 1.3;
            word-break: break-word;
        }

        .draw-player-club {
            font-size: 11px;
            color: #6c757d;
            opacity: 0.85;
            line-height: 1.3;
            margin: 0;
            word-break: break-word;
        }

        .match-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 12px 0;
        }

        .vs-label {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-color);
            background: #f0f4ff;
            padding: 4px 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .match-container .placeholder-card,
        .match-container .draw-slot,
        .animation-container .draw-slot {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        .animation-container .draw-player-card {
            position: relative;
            z-index: 1;
        }
        .match-container > div {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
        }
        .match-container .draw-player-card {
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 12px 15px;
            width: 200px;
            max-width: 220px;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        .match-container .placeholder,
        .match-container .draw-slot,
        .match-container .waiting-card,
        .match-container .drop-target {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            display: contents !important;
        }
        .match-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .animation-container .draw-player-card {
            position: static !important;
            margin: 10px auto !important;
            z-index: 1 !important;
        }

        #drawsContent .match-container {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            gap: 20px !important;
            margin: 20px 0 !important;
            flex-wrap: wrap !important;
        }

        .animation-container .draw-slot,
        .animation-container .placeholder-card,
        .animation-container .waiting-card,
        .animation-container .drop-target {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: auto !important;
            height: auto !important;
        }

        #animatedBracket {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 100%;
        box-sizing: border-box;
        padding: 4px;
        max-height: 70vh;
        overflow-y: auto;
        }

        .match-slot {
            display: flex !important;
            flex-direction: row !important;
            justify-content: center !important;
            align-items: stretch !important;
            gap: 8px !important;
            width: 100%;
            box-sizing: border-box;
            padding: 3px 0;
            opacity: 1;
            transform: none !important;
            position: relative !important;
            min-height: 60px;
        }

        .match-slot .slot-left,
        .match-slot .slot-right {
            display: flex !important;
            align-items: stretch !important;
            justify-content: center !important;
            min-width: 0;
            flex: 1 1 0;
            max-width: 45%;
            box-sizing: border-box;
        }

        .match-slot .slot-name {
            display: flex !important;
            align-items: stretch !important;
            justify-content: center !important;
            width: 100%;
            height: 100% !important;
            padding: 0;
            box-sizing: border-box;
            background: transparent !important;
            border: none !important;
        }

        #animatedBracket .draw-player-card {
            position: static !important;
            margin: 0 !important;
            z-index: 1 !important;
            width: 100% !important;
            max-width: 100%;
            height: 100%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }


        #animatedBracket .slot-left .slot-name,
        #animatedBracket .slot-right .slot-name {
            min-height: 54px;
        }


        .match-slot .vs-label {
            flex: 0 0 auto;
            margin: 0;
            font-weight: 700;
            font-size: 12px;
            color: var(--primary-color);
            background: #f0f4ff;
            padding: 6px 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            align-self: center;
        }

        .floating-clone {
            position: fixed !important;
            left: 0;
            top: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            transform: translate(0,0) scale(1);
            transition: transform 0.6s cubic-bezier(.2,.9,.25,1), opacity 0.4s ease;
            will-change: transform, opacity;
            z-index: 9999 !important;
        }

        .floating-clone .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .match-slot {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }

            .match-slot .slot-left,
            .match-slot .slot-right {
                width: 100%;
            }

            #animatedBracket .draw-player-card {
                max-width: 100%;
            }
        }
        #animatedBracket .slot-name {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }
        #animatedBracket .slot-left,
        #animatedBracket .slot-right {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }


    </style>
</head>
<body>
<div class="draws-container">
    <div class="draws-header">
        <h1><i class="fas fa-trophy"></i> Generate Draws</h1>
        <div class="actions">
            <a href="tournament-matches.html" class="btn btn-primary" target="_blank" rel="noopener noreferrer">
                <i class="fas fa-calendar-alt"></i> Scheduled Matches
            </a>
            <a href="player-list.html" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> Back to Players
            </a>
        </div>
    </div>

    <div class="filters-container" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px;">
        <div class="filter-group" style="flex: 0 0 auto; min-width: 150px;">
            <label for="drawGenderFilter" style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Gender</label>
            <select id="drawGenderFilter" class="filter-select" style="width: 100%;">
                <option value="">All Genders</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="filter-group" style="flex: 0 0 auto; min-width: 180px;">
            <label for="drawWeightFilter" style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Weight Category</label>
            <select id="drawWeightFilter" class="filter-select" style="width: 100%;">
                <option value="">All Weights</option>
                <!-- Will be populated by JavaScript -->
            </select>
        </div>
        <div style="flex: 0 0 auto; display: flex; gap: 10px; align-items: flex-end;">
            <button id="shufflePlayersBtn" class="btn btn-outline">
                <i class="fas fa-shuffle"></i> Shuffle Players
            </button>
            <button id="manageSeedsBtn" class="btn btn-outline" style="background: #f8f9fa; border-color: #dee2e6;">
                <i class="fas fa-trophy"></i> Manage Seeds
            </button>
            <button id="generateDrawBtn" class="btn btn-primary">
                <i class="fas fa-random"></i> Generate IJF Draw
            </button>
        </div>
    </div>

    <div class="draws-content">
        <div class="draws-layout">
            <!-- Left Column: Player List -->
            <div class="players-column">
                <h3 style="color: var(--primary-color); font-size: 1.3rem; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--primary-color); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-users"></i> Registered Players
                </h3>
                <div id="playersList" class="players-grid">
                    <!-- Players will be populated here by JavaScript -->
                    <div class="no-players">
                        <i class="fas fa-users" style="font-size: 2rem; opacity: 0.5; margin-bottom: 10px; display: block;"></i>
                        <p>Select filters to view players</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Draw Animation -->
            <div class="animation-column">
                <h3 style="color: var(--primary-color); font-size: 1.3rem; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--primary-color); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-chess-board"></i> Draw Preview
                </h3>
                <div id="drawsContent" class="animation-container">
                    <div class="no-draw">
                        <i class="fas fa-random" style="font-size: 2rem; opacity: 0.5; margin-bottom: 10px; display: block;"></i>
                        <p>Click "Generate Draw" to create tournament matches</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seeding Modal -->
<div id="seedingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 24px; color: #333;">
                <i class="fas fa-trophy" style="color: #ffd700;"></i> IJF Seeding Management
            </h2>
            <button id="closeSeedingModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="margin: 0; font-size: 14px; color: #666;">
                <i class="fas fa-info-circle"></i> 
                Assign seeds to players following IJF rules. Seed 1 goes to top, Seed 2 to bottom, Seeds 3-4 in opposite halves.
            </p>
        </div>
        
        <div id="seedingList" style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Seeding slots will be populated here -->
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 25px; justify-content: flex-end;">
            <button id="clearSeeds" class="btn btn-outline" style="padding: 10px 20px;">
                <i class="fas fa-eraser"></i> Clear All Seeds
            </button>
            <button id="saveSeedsBtn" class="btn btn-primary" style="padding: 10px 20px;">
                <i class="fas fa-save"></i> Save Seeds
            </button>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Firebase config and initialization -->
<script src="../public/js/firebase.js"></script>

<!-- Authentication Guard - MUST be loaded before other scripts -->
<script src="../public/js/auth-guard.js"></script>

<!-- Match Manager for multi-device integration -->
<script src="../public/js/match-manager.js"></script>

<script src="../public/js/generate-draws.js"></script>

<!-- Integration between draw and match manager -->
<script src="../public/js/draw-to-matches-integration.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const shuffleBtn = document.getElementById("shufflePlayersBtn");
        const playersList = document.getElementById("playersList");
        const manageSeedsBtn = document.getElementById("manageSeedsBtn");
        const seedingModal = document.getElementById("seedingModal");
        const closeSeedingModal = document.getElementById("closeSeedingModal");
        const saveSeedsBtn = document.getElementById("saveSeedsBtn");
        const clearSeeds = document.getElementById("clearSeeds");
        const seedingList = document.getElementById("seedingList");
        
        // Store seeds in memory
        let playerSeeds = {};

        // Function to shuffle an array (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        shuffleBtn.addEventListener("click", () => {
            const playerCards = Array.from(playersList.querySelectorAll(".player-card"));
            if (playerCards.length <= 1) return; // nothing to shuffle

            // Note: This shuffle only affects visual display order
            // Seed assignments are preserved in player data
            console.log('ℹ️ Shuffling visual display only - seed assignments preserved');

            // Add shuffle animation class
            playersList.style.transition = "transform 0.4s ease";
            playersList.style.transform = "rotate(2deg) scale(0.98)";
            shuffleBtn.disabled = true;
            shuffleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Shuffling...';

            setTimeout(() => {
                playersList.style.transform = "rotate(0deg) scale(1)";

                // Shuffle DOM elements
                const shuffled = shuffleArray(playerCards);
                playersList.innerHTML = "";
                shuffled.forEach(card => playersList.appendChild(card));

                // Add fade-in animation
                playersList.querySelectorAll(".player-card").forEach((card, index) => {
                    card.style.opacity = 0;
                    card.style.transform = "translateY(10px)";
                    setTimeout(() => {
                        card.style.transition = "opacity 0.4s ease, transform 0.4s ease";
                        card.style.opacity = 1;
                        card.style.transform = "translateY(0)";
                    }, 80 * index);
                });

                shuffleBtn.disabled = false;
                shuffleBtn.innerHTML = '<i class="fas fa-shuffle"></i> Shuffle Players';
            }, 600);
        });
        
        // Seeding Modal Functions
        manageSeedsBtn.addEventListener("click", () => {
            openSeedingModal();
        });
        
        closeSeedingModal.addEventListener("click", () => {
            seedingModal.style.display = "none";
        });
        
        seedingModal.addEventListener("click", (e) => {
            if (e.target === seedingModal) {
                seedingModal.style.display = "none";
            }
        });
        
        function openSeedingModal() {
            // Get current filtered players
            const selectedGender = document.getElementById('drawGenderFilter').value;
            const selectedWeight = document.getElementById('drawWeightFilter').value;
            
            const filteredPlayers = players.filter(player => {
                if (!player.playerInfo) return false;
                const playerGender = player.playerInfo.gender ? player.playerInfo.gender.toLowerCase() : '';
                const matchesGender = !selectedGender || playerGender === selectedGender.toLowerCase();
                const playerWeight = player.playerInfo.weight ? player.playerInfo.weight.toString() : '';
                const matchesWeight = !selectedWeight || playerWeight === selectedWeight;
                return matchesGender && matchesWeight;
            });
            
            if (filteredPlayers.length < 2) {
                alert('Need at least 2 players to assign seeds. Please adjust filters.');
                return;
            }
            
            // Populate seeding list
            populateSeedingList(filteredPlayers);
            seedingModal.style.display = "flex";
        }
        
        function populateSeedingList(filteredPlayers) {
            const maxSeeds = Math.min(8, filteredPlayers.length); // Allow up to 8 seeds
            seedingList.innerHTML = '';
            
            for (let i = 1; i <= maxSeeds; i++) {
                const seedDiv = document.createElement('div');
                seedDiv.style.cssText = 'display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;';
                
                const seedLabel = document.createElement('div');
                seedLabel.style.cssText = 'font-weight: 600; font-size: 18px; color: #ffd700; min-width: 80px;';
                seedLabel.innerHTML = `<i class="fas fa-medal"></i> Seed ${i}`;
                
                const select = document.createElement('select');
                select.id = `seed${i}`;
                select.style.cssText = 'flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;';
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select Player --';
                select.appendChild(defaultOption);
                
                filteredPlayers.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = `${player.fullName} ${player.playerInfo?.team ? '(' + player.playerInfo.team + ')' : ''}`;
                    
                    // Pre-select if already seeded
                    if (playerSeeds[player.id] === i) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
                
                seedDiv.appendChild(seedLabel);
                seedDiv.appendChild(select);
                seedingList.appendChild(seedDiv);
            }
        }
        
        saveSeedsBtn.addEventListener("click", () => {
            // Save seeds from modal
            playerSeeds = {};
            const maxSeeds = seedingList.children.length;
            
            for (let i = 1; i <= maxSeeds; i++) {
                const select = document.getElementById(`seed${i}`);
                if (select && select.value) {
                    playerSeeds[select.value] = i;
                }
            }
            
            // Apply seeds to player objects
            players.forEach(player => {
                if (playerSeeds[player.id]) {
                    player.seed = playerSeeds[player.id];
                } else {
                    delete player.seed;
                }
            });
            
            console.log('Seeds saved:', playerSeeds);
            alert(`✅ Seeds saved successfully! ${Object.keys(playerSeeds).length} players seeded.`);
            seedingModal.style.display = "none";
            
            // Update player list display to show seeds
            filterAndRenderDraws();
        });
        
        clearSeeds.addEventListener("click", () => {
            if (confirm('Clear all seeds?')) {
                playerSeeds = {};
                players.forEach(player => delete player.seed);
                populateSeedingList(players.filter(p => p.playerInfo));
                console.log('All seeds cleared');
            }
        });
    });
</script>

</body>
</html>
